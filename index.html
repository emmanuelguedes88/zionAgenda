import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, 
  onAuthStateChanged, signOut 
} from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, getDoc } from 'firebase/firestore';
import { 
  User, MapPin, Church, BookOpen, Users, Briefcase, FileText, 
  Printer, Plus, Minus, ChevronRight, ChevronLeft, 
  Calendar, Building2, Heart, Coins, ShieldCheck,
  Star, Smartphone, LogOut, Lock, Mail, Eye, EyeOff, 
  AlertCircle, Loader2, Wine, Waves, ScrollText, Clock, FileDown
} from 'lucide-react';

// --- CONFIGURA√á√ÉO FIREBASE ---
const firebaseConfig = {
  apiKey: "AIzaSyA-Ein7ax-djeF8IXF_mXc3IfsLYN_itWU",
  authDomain: "agendaipb.firebaseapp.com",
  projectId: "agendaipb",
  storageBucket: "agendaipb.firebasestorage.app",
  messagingSenderId: "811819165566",
  appId: "1:811819165566:web:ed4bdde94ac1e70ba4752f",
  measurementId: "G-YVSKQVFRQ1"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const DB_ID = "relatorio-presbiteriano-v15";

// --- ESTADO INICIAL COMPLETO (BASEADO NO RELAT√ìRIO 17H51) ---
const INITIAL_STATE = {
  header: { ano: '2025', sinodo: '', presbiterio: '', siglaSinodo: '', siglaPresbiterio: '' },
  identificacao: {
    nome: '', filiacaoPai: '', filiacaoMae: '', dataNascimento: '', localNascimento: '', ufNascimento: '',
    rg: '', orgaoEmissor: '', cpf: '', estadoCivil: 'Casado', conjuge: '', niverConjuge: '',
    dependentes: '0', endereco: '', numero: '', complemento: '', bairro: '', cidade: '', uf: '', cep: '',
    telefoneResidencia: '', celular: '', telefoneIgreja: '', email: '',
    moradia: 'pastoral', // pastoral, aluguel_igreja, aluguel_ministro, propria_quitada, propria_financiada
    localizacaoMoradia: 'dentro', // dentro, fora
    dataOrdenacao: '', dedicacao: 'integral', ferias: 'regulares', 
    congruas: '', aposentadoriaPublica: false, aposentadoriaPrivada: false,
    planoSaude: false, inssSobreCongrua: false, valorInss: '', previdenciaPrivada: false
  },
  campoTrabalho: { igrejas: '', congregacoes: '' },
  atuacaoMinisterial: {
    doutrinacao: [
      { id: 'pregacao', label: 'üìñ Prega√ß√µes', noCampo: 0, foraCampo: 0 },
      { id: 'ed', label: 'üè´ Aulas de Escola Dominical', noCampo: 0, foraCampo: 0 },
      { id: 'evangelizacao', label: 'üì¢ Trabalhos de Evangeliza√ß√£o', noCampo: 0, foraCampo: 0 },
      { id: 'estudo', label: 'üîç Estudo B√≠blico', noCampo: 0, foraCampo: 0 },
      { id: 'palestras', label: 'üé§ Palestras', noCampo: 0, foraCampo: 0 },
      { id: 'prelecoes', label: 'üéñÔ∏è Prele√ß√µes Especiais', noCampo: 0, foraCampo: 0 },
      { id: 'media', label: 'üì∫ Mensagens R√°dio/TV', noCampo: 0, foraCampo: 0 },
      { id: 'artigos', label: '‚úçÔ∏è Artigos (Jornais/Revistas)', noCampo: 0, foraCampo: 0 },
      { id: 'entrevistas', label: 'üéôÔ∏è Entrevistas', noCampo: 0, foraCampo: 0 },
    ],
    atos: [
      { id: 'ceias', label: 'üç∑ Santas Ceias', noCampo: 0, foraCampo: 0 },
      { id: 'casamentos', label: 'üíç B√™n√ß√£os N√∫pcias', noCampo: 0, foraCampo: 0 },
      { id: 'funerais', label: 'üïäÔ∏è Funerais', noCampo: 0, foraCampo: 0 },
      { id: 'batismos_infantis', label: 'üë∂ Batismos Infantis', noCampo: 0, foraCampo: 0 },
      { id: 'profissoes', label: 'ü§ù Profiss√µes de F√©', noCampo: 0, foraCampo: 0 },
      { id: 'profissao_batismo', label: 'üåä Profiss√µes de F√© e Batismo', noCampo: 0, foraCampo: 0 },
    ],
    assistencia: [
      { id: 'aconselhamento', label: 'üó£Ô∏è Aconselhamento', noCampo: 0, foraCampo: 0 },
      { id: 'visitas', label: 'üè† Visitas (Lares)', noCampo: 0, foraCampo: 0 },
      { id: 'pontos', label: 'üìç Pontos de Prega√ß√£o', noCampo: 0, foraCampo: 0 },
      { id: 'missoes', label: 'üåç Miss√µes', noCampo: 0, foraCampo: 0 },
      { id: 'departamentos', label: 'üë• Departamentos', noCampo: 0, foraCampo: 0 },
    ],
    designado: { descricao: '' }
  },
  atuacaoConciliar: {
    concilios: [
      { id: 'conselho', label: 'üèõÔ∏è Reuni√µes do Conselho', noCampo: 0, foraCampo: 0 },
      { id: 'assembleias', label: 'üó≥Ô∏è Assembleias Gerais', noCampo: 0, foraCampo: 0 },
      { id: 'presbiterio', label: 'üìê Reuni√µes do Presbit√©rio', noCampo: 0, foraCampo: 0 },
      { id: 'sinodo', label: 'üó∫Ô∏è Reuni√µes do S√≠nodo', noCampo: 0, foraCampo: 0 },
      { id: 'sc', label: '‚öñÔ∏è Reuni√µes Supremo Conc√≠lio', noCampo: 0, foraCampo: 0 },
      { id: 'diaconos', label: 'üëî Di√°conos Ordenados', noCampo: 0, foraCampo: 0 },
      { id: 'presbiteros', label: 'üìú Presb√≠teros Ordenados', noCampo: 0, foraCampo: 0 },
    ],
    cargos: { presbiterio: '', sinodo: '', sc: '', juntas: '', textoComplementar: '' }
  },
  outrasAtividades: {
    atualizacao: '', paraeclesiastica: '', extraministerial: '', outras: '',
    local: '', dataGeracao: new Date().toLocaleDateString('pt-BR')
  }
};

export default function App() {
  const [user, setUser] = useState(null);
  const [report, setReport] = useState(INITIAL_STATE);
  const [tab, setTab] = useState(0); 
  const [loading, setLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [isGenerating, setIsGenerating] = useState(false);
  
  // Auth UI
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [isRegistering, setIsRegistering] = useState(false);
  const [authError, setAuthError] = useState('');
  const [showPassword, setShowPassword] = useState(false);

  const reportPrintRef = useRef(null);

  // Injetar script html2pdf via CDN
  useEffect(() => {
    if (!document.getElementById('html2pdf-cdn')) {
      const script = document.createElement('script');
      script.id = 'html2pdf-cdn';
      script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
      document.body.appendChild(script);
    }
  }, []);

  // Monitorar Autentica√ß√£o
  useEffect(() => {
    const unsub = onAuthStateChanged(auth, (u) => {
      setUser(u);
      if (!u) setLoading(false);
    });
    return () => unsub();
  }, []);

  // Monitorar Firestore
  useEffect(() => {
    if (!user) return;
    const reportRef = doc(db, 'artifacts', DB_ID, 'users', user.uid, 'data', 'relatorio');
    const unsub = onSnapshot(reportRef, (snap) => {
      if (snap.exists()) {
        setReport(prev => ({ ...prev, ...snap.data() }));
      } else {
        setDoc(reportRef, INITIAL_STATE);
      }
      setLoading(false);
    }, (err) => {
      console.error(err);
      setLoading(false);
    });
    return () => unsub();
  }, [user]);

  const saveToCloud = async (newData) => {
    if (!user) return;
    setIsSaving(true);
    try {
      const reportRef = doc(db, 'artifacts', DB_ID, 'users', user.uid, 'data', 'relatorio');
      await setDoc(reportRef, newData);
    } catch (e) { console.error(e); }
    finally { setIsSaving(false); }
  };

  const update = (section, field, value) => {
    const newData = { ...report, [section]: { ...report[section], [field]: value } };
    setReport(newData);
    saveToCloud(newData);
  };

  const updateCounter = (section, listKey, id, field, delta) => {
    const list = [...report[section][listKey]];
    const index = list.findIndex(item => item.id === id);
    if (index !== -1) {
      list[index][field] = Math.max(0, (list[index][field] || 0) + delta);
    }
    const newData = { ...report, [section]: { ...report[section], [listKey]: list } };
    setReport(newData); // UI instant√¢nea
    saveToCloud(newData);
  };

  const generatePDF = () => {
    if (!window.html2pdf) {
      alert("Aguarde o carregamento do motor de PDF (1-2 segundos).");
      return;
    }
    setIsGenerating(true);
    const element = reportPrintRef.current;
    const opt = {
      margin: 10,
      filename: `Relatorio_Ministro_${report.header.ano}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    
    window.html2pdf().from(element).set(opt).save()
      .then(() => setIsGenerating(false))
      .catch(() => setIsGenerating(false));
  };

  const handleAuth = async (e) => {
    e.preventDefault();
    setAuthError('');
    try {
      if (isRegistering) await createUserWithEmailAndPassword(auth, email, password);
      else await signInWithEmailAndPassword(auth, email, password);
    } catch (err) { setAuthError("Falha na autentica√ß√£o."); }
  };

  if (loading) return <div className="h-screen flex items-center justify-center bg-slate-50"><Loader2 className="animate-spin text-indigo-600" /></div>;

  if (!user) {
    return (
      <div className="min-h-screen bg-slate-100 flex items-center justify-center p-6 font-sans">
        <div className="w-full max-w-md">
          <div className="text-center mb-8">
            <div className="bg-slate-900 w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-xl">
              <Star className="text-amber-400 fill-amber-400" size={32} />
            </div>
            <h1 className="text-2xl font-black text-slate-800 tracking-tight italic">Relat√≥rio Ministerial</h1>
            <p className="text-slate-400 text-[10px] font-black uppercase tracking-[2px]">Acesso Seguro IPB</p>
          </div>
          <div className="bg-white p-8 rounded-[32px] shadow-2xl border border-white">
            <form onSubmit={handleAuth} className="space-y-4">
              <InputField label="E-mail" type="email" value={email} onChange={setEmail} icon={<Mail size={18}/>} />
              <div className="relative">
                <InputField label="Senha" type={showPassword ? "text" : "password"} value={password} onChange={setPassword} icon={<Lock size={18}/>} />
                <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-4 top-[38px] text-slate-300">
                  {showPassword ? <EyeOff size={16} /> : <Eye size={16} />}
                </button>
              </div>
              {authError && <p className="text-red-500 text-[10px] font-bold">{authError}</p>}
              <button className="w-full bg-slate-900 text-white py-4 rounded-xl font-black uppercase tracking-widest shadow-xl hover:bg-black transition-all">
                {isRegistering ? 'Cadastrar' : 'Entrar'}
              </button>
            </form>
            <button onClick={() => setIsRegistering(!isRegistering)} className="w-full text-center mt-6 text-[10px] font-black text-indigo-500 uppercase tracking-widest">
              {isRegistering ? 'Voltar' : 'Criar nova conta?'}
            </button>
          </div>
        </div>
      </div>
    );
  }

  const tabs = [
    { label: 'Agenda', icon: <Clock size={18} /> },
    { label: 'Identifica√ß√£o', icon: <User size={18} /> },
    { label: 'Atua√ß√£o', icon: <Church size={18} /> },
    { label: 'Conc√≠lios', icon: <Building2 size={18} /> },
    { label: 'Documento', icon: <Printer size={18} /> }
  ];

  return (
    <div className="min-h-screen bg-slate-50 pb-24 font-sans text-slate-900 overflow-x-hidden">
      
      {/* HEADER */}
      <header className="bg-white border-b p-4 no-print flex justify-between items-center sticky top-0 z-50">
        <div className="flex items-center gap-3">
          <div className="bg-slate-900 p-1.5 rounded-lg text-white shadow-lg"><Star size={16} fill="white" /></div>
          <h1 className="text-xs font-black uppercase tracking-tighter">Agenda do Ministro</h1>
        </div>
        <div className="flex items-center gap-3">
          {isSaving && <div className="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>}
          <button onClick={() => signOut(auth)} className="text-slate-300 hover:text-red-500 transition-colors"><LogOut size={18} /></button>
        </div>
      </header>

      {/* NAVEGA√á√ÉO */}
      <nav className="bg-white border-b flex overflow-x-auto no-print sticky top-[57px] z-40 shadow-sm scrollbar-hide">
        {tabs.map((t, i) => (
          <button key={i} onClick={() => setTab(i)}
            className={`flex-1 flex flex-col items-center justify-center gap-1 px-4 py-3 text-[9px] font-black uppercase tracking-widest transition-all border-b-4 ${
              tab === i ? 'border-indigo-600 text-indigo-600 bg-indigo-50/20' : 'border-transparent text-slate-300'
            }`}
          >
            {t.icon}
          </button>
        ))}
      </nav>

      <main className="max-w-4xl mx-auto p-4 md:p-8 space-y-6">
        
        {/* TAB 0: AGENDA DI√ÅRIA */}
        {tab === 0 && (
          <div className="space-y-6 animate-in fade-in duration-500">
            <div className="bg-indigo-900 p-8 rounded-[32px] text-white shadow-xl flex justify-between items-center relative overflow-hidden">
               <div className="relative z-10">
                <p className="text-indigo-400 text-[10px] font-black uppercase tracking-[3px] mb-1">Registro de Hoje</p>
                <h2 className="text-2xl font-black">{new Date().toLocaleDateString('pt-BR', { day: 'numeric', month: 'long', year: 'numeric' })}</h2>
              </div>
              <Clock size={40} className="opacity-10 absolute -right-2 -bottom-2" />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <AgendaBlock title="üìñ Doutrina√ß√£o" items={report.atuacaoMinisterial.doutrinacao} onAdd={(id) => updateCounter('atuacaoMinisterial', 'doutrinacao', id, 'noCampo', 1)} />
              <AgendaBlock title="‚õ™ Atos Pastorais" items={report.atuacaoMinisterial.atos} onAdd={(id) => updateCounter('atuacaoMinisterial', 'atos', id, 'noCampo', 1)} />
            </div>
          </div>
        )}

        {/* TAB 1: IDENTIFICA√á√ÉO DETALHADA */}
        {tab === 1 && (
          <div className="space-y-6 animate-in fade-in duration-500 pb-10">
            <Section title="üìë Identifica√ß√£o do Per√≠odo" icon={<FileText size={18} />}>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <InputField label="Ano Civil" value={report.header.ano} onChange={v => update('header', 'ano', v)} />
                <InputField label="S√≠nodo" value={report.header.sinodo} onChange={v => update('header', 'sinodo', v)} />
                <InputField label="Presbit√©rio" value={report.header.presbiterio} onChange={v => update('header', 'presbiterio', v)} />
              </div>
            </Section>

            <Section title="üë§ I - Identifica√ß√£o do Ministro" icon={<User size={18} />}>
              <div className="space-y-4">
                <InputField label="Nome Completo" value={report.identificacao.nome} onChange={v => update('identificacao', 'nome', v)} />
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <InputField label="Filia√ß√£o (Pai)" value={report.identificacao.filiacaoPai} onChange={v => update('identificacao', 'filiacaoPai', v)} />
                  <InputField label="Filia√ß√£o (M√£e)" value={report.identificacao.filiacaoMae} onChange={v => update('identificacao', 'filiacaoMae', v)} />
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <InputField label="Data Nascimento" type="date" value={report.identificacao.dataNascimento} onChange={v => update('identificacao', 'dataNascimento', v)} />
                  <InputField label="Local (Cidade)" value={report.identificacao.localNascimento} onChange={v => update('identificacao', 'localNascimento', v)} />
                  <InputField label="UF" value={report.identificacao.ufNascimento} onChange={v => update('identificacao', 'ufNascimento', v)} />
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <InputField label="RG / √ìrg√£o" value={report.identificacao.rg} onChange={v => update('identificacao', 'rg', v)} />
                  <InputField label="CPF" value={report.identificacao.cpf} onChange={v => update('identificacao', 'cpf', v)} />
                  <SelectField label="Estado Civil" value={report.identificacao.estadoCivil} options={['Solteiro', 'Casado', 'Divorciado', 'Vi√∫vo']} onChange={v => update('identificacao', 'estadoCivil', v)} />
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <InputField label="C√¥njuge" value={report.identificacao.conjuge} onChange={v => update('identificacao', 'conjuge', v)} />
                  <InputField label="Anivers√°rio C√¥njuge" type="date" value={report.identificacao.niverConjuge} onChange={v => update('identificacao', 'niverConjuge', v)} />
                  <InputField label="N¬∫ de Dependentes" type="number" value={report.identificacao.dependentes} onChange={v => update('identificacao', 'dependentes', v)} />
                </div>
              </div>
            </Section>

            <Section title="üè† Endere√ßo e Moradia" icon={<Smartphone size={18} />}>
              <div className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="md:col-span-2"><InputField label="Logradouro" value={report.identificacao.endereco} onChange={v => update('identificacao', 'endereco', v)} /></div>
                  <InputField label="N¬∫ / Comp." value={report.identificacao.numero} onChange={v => update('identificacao', 'numero', v)} />
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <InputField label="Bairro" value={report.identificacao.bairro} onChange={v => update('identificacao', 'bairro', v)} />
                  <InputField label="Cidade" value={report.identificacao.cidade} onChange={v => update('identificacao', 'cidade', v)} />
                  <InputField label="CEP" value={report.identificacao.cep} onChange={v => update('identificacao', 'cep', v)} />
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <InputField label="Celular" value={report.identificacao.celular} onChange={v => update('identificacao', 'celular', v)} />
                  <InputField label="E-mail Oficial" value={report.identificacao.email} onChange={v => update('identificacao', 'email', v)} />
                </div>
                <hr className="my-2" />
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <SelectField label="Condi√ß√µes de Moradia" value={report.identificacao.moradia} options={{pastoral: 'Casa/Apto Pastoral', aluguel_igreja: 'Aluguel Igreja', propria_quitada: 'Pr√≥pria Quitada', propria_financiada: 'Pr√≥pria Financiada'}} onChange={v => update('identificacao', 'moradia', v)} />
                  <SelectField label="Localiza√ß√£o" value={report.identificacao.localizacaoMoradia} options={{dentro: 'Limites do Campo', fora: 'Fora do Campo'}} onChange={v => update('identificacao', 'localizacaoMoradia', v)} />
                </div>
              </div>
            </Section>

            <Section title="üí∞ Financeiro e Minist√©rio" icon={<Coins size={18} />}>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <InputField label="Ordena√ß√£o" type="date" value={report.identificacao.dataOrdenacao} onChange={v => update('identificacao', 'dataOrdenacao', v)} />
                  <SelectField label="Dedica√ß√£o" value={report.identificacao.dedicacao} options={{integral: 'Integral', parcial: 'Parcial'}} onChange={v => update('identificacao', 'dedicacao', v)} />
                  <InputField label="C√¥ngruas (R$)" value={report.identificacao.congruas} onChange={v => update('identificacao', 'congruas', v)} />
              </div>
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                  <Checkbox label="Plano Sa√∫de" checked={report.identificacao.planoSaude} onChange={v => update('identificacao', 'planoSaude', v)} />
                  <Checkbox label="Aposentadoria" checked={report.identificacao.aposentadoriaPublica} onChange={v => update('identificacao', 'aposentadoriaPublica', v)} />
                  <Checkbox label="INSS s/ C√¥ngrua" checked={report.identificacao.inssSobreCongrua} onChange={v => update('identificacao', 'inssSobreCongrua', v)} />
                  <InputField label="Valor INSS" value={report.identificacao.valorInss} onChange={v => update('identificacao', 'valorInss', v)} />
              </div>
            </Section>
          </div>
        )}

        {/* TAB 2: ATUA√á√ÉO MINISTERIAL */}
        {tab === 2 && (
          <div className="space-y-8 animate-in fade-in duration-500 pb-10">
             <Section title="üïç II - Campo de Trabalho" icon={<Church size={18} />}>
                <TextAreaField label="Igrejas e Congrega√ß√µes sob Responsabilidade" value={report.campoTrabalho.igrejas} onChange={v => update('campoTrabalho', 'igrejas', v)} />
             </Section>
             <StatTable title="1. Doutrina√ß√£o" icon={<BookOpen size={18} />} items={report.atuacaoMinisterial.doutrinacao} onDelta={(id, f, d) => updateCounter('atuacaoMinisterial', 'doutrinacao', id, f, d)} />
             <StatTable title="2. Atos Pastorais" icon={<Wine size={18} />} items={report.atuacaoMinisterial.atos} onDelta={(id, f, d) => updateCounter('atuacaoMinisterial', 'atos', id, f, d)} />
             <StatTable title="3. Assist√™ncia Pastoral" icon={<Users size={18} />} items={report.atuacaoMinisterial.assistencia} onDelta={(id, f, d) => updateCounter('atuacaoMinisterial', 'assistencia', id, f, d)} />
             <Section title="üìù 4. Minist√©rio Designado (Art 37)" icon={<ScrollText size={18} />}>
                <TextAreaField placeholder="Descri√ß√£o das atividades..." value={report.atuacaoMinisterial.designado.descricao} onChange={v => update('atuacaoMinisterial', 'designado', { descricao: v })} />
             </Section>
          </div>
        )}

        {/* TAB 3: CONC√çLIOS */}
        {tab === 3 && (
          <div className="space-y-8 animate-in fade-in duration-500 pb-10">
             <StatTable title="IV - Atua√ß√£o Conciliar" icon={<Building2 size={18} />} items={report.atuacaoConciliar.concilios} onDelta={(id, f, d) => updateCounter('atuacaoConciliar', 'concilios', id, f, d)} />
             <Section title="üíº Cargos e Fun√ß√µes" icon={<Briefcase size={18} />}>
                <TextAreaField placeholder="Mencionar cargos e reuni√µes..." value={report.atuacaoConciliar.cargos.textoComplementar} onChange={v => update('atuacaoConciliar', 'cargos', {...report.atuacaoConciliar.cargos, textoComplementar: v})} />
             </Section>
             <Section title="üåü V. Outras Atividades" icon={<Star size={18} />}>
                <TextAreaField label="Atualiza√ß√£o / Aperfei√ßoamento" value={report.outrasAtividades.atualizacao} onChange={v => update('outrasAtividades', 'atualizacao', v)} />
                <TextAreaField label="Atividades Extra Ministeriais" value={report.outrasAtividades.extraministerial} onChange={v => update('outrasAtividades', 'extraministerial', v)} />
                <div className="grid grid-cols-2 gap-4 mt-4">
                   <InputField label="Local" value={report.outrasAtividades.local} onChange={v => update('outrasAtividades', 'local', v)} />
                   <InputField label="Data do Relat√≥rio" type="date" value={report.outrasAtividades.dataGeracao} onChange={v => update('outrasAtividades', 'dataGeracao', v)} />
                </div>
             </Section>
          </div>
        )}

        {/* TAB 4: RELAT√ìRIO PDF (VISUALIZA√á√ÉO COMPLETA) */}
        {tab === 4 && (
          <div className="space-y-6 animate-in zoom-in-95 duration-500">
            <div className="bg-slate-900 text-white p-8 rounded-[40px] flex justify-between items-center no-print shadow-2xl">
              <div>
                <h3 className="font-black text-xl italic tracking-tighter uppercase">Documento Oficial</h3>
                <p className="text-xs text-slate-400">Gere o PDF para apresentar aos conc√≠lios.</p>
              </div>
              <button 
                onClick={generatePDF}
                disabled={isGenerating}
                className="bg-white text-slate-900 px-8 py-4 rounded-2xl font-black flex items-center gap-2 hover:scale-105 transition-all shadow-xl disabled:opacity-50"
              >
                {isGenerating ? <Loader2 className="animate-spin" /> : <FileDown size={20} />}
                {isGenerating ? "GERANDO..." : "BAIXAR PDF"}
              </button>
            </div>

            {/* PREVIEW DO DOCUMENTO (FORMATO PAPEL) */}
            <div id="pdf-container" className="bg-white shadow-2xl border border-slate-200 p-8 md:p-16 text-black mx-auto w-full max-w-[850px] font-serif leading-snug">
               <div ref={reportPrintRef}>
                  <div className="text-center border-b-4 border-black pb-4 mb-10">
                    <h1 className="text-2xl font-black uppercase">Relat√≥rio do Ministro Presbiteriano</h1>
                    <div className="flex justify-center gap-8 text-[10px] font-black uppercase mt-2">
                      <span>ANO: {report.header.ano || '____'}</span>
                      <span>S√çNODO: {report.header.sinodo || '__________'}</span>
                      <span>PRESBIT√âRIO: {report.header.presbiterio || '__________'}</span>
                    </div>
                  </div>

                  <div className="space-y-8 text-[11px]">
                    <section>
                      <h2 className="bg-slate-50 p-1 font-bold border-l-8 border-black mb-3 uppercase italic">I - Identifica√ß√£o do Ministro</h2>
                      <div className="grid grid-cols-2 gap-x-12 gap-y-2">
                        <p className="border-b border-slate-100 pb-1"><strong>Nome:</strong> {report.identificacao.nome}</p>
                        <p className="border-b border-slate-100 pb-1"><strong>Filia√ß√£o:</strong> {report.identificacao.filiacaoPai} e {report.identificacao.filiacaoMae}</p>
                        <p className="border-b border-slate-100 pb-1"><strong>CPF:</strong> {report.identificacao.cpf} | <strong>RG:</strong> {report.identificacao.rg}</p>
                        <p className="border-b border-slate-100 pb-1"><strong>Nascimento:</strong> {report.identificacao.dataNascimento} ({report.identificacao.localNascimento})</p>
                        <p className="border-b border-slate-100 pb-1"><strong>Endere√ßo:</strong> {report.identificacao.endereco}, {report.identificacao.numero}</p>
                        <p className="border-b border-slate-100 pb-1"><strong>Contato:</strong> {report.identificacao.celular} | {report.identificacao.email}</p>
                      </div>
                    </section>

                    <section>
                      <h2 className="bg-slate-50 p-1 font-bold border-l-8 border-black mb-3 uppercase italic">II - Atua√ß√£o Ministerial (Estat√≠stica)</h2>
                      <div className="grid grid-cols-2 gap-12">
                        <div>
                          <p className="font-bold border-b-2 border-black mb-2 uppercase">1. Doutrina√ß√£o</p>
                          {report.atuacaoMinisterial.doutrinacao.map(i => (
                            <div key={i.id} className="flex justify-between border-b border-slate-50 py-1 italic">
                              <span>{i.label.substring(3)}</span> <span className="font-bold">{i.noCampo + i.foraCampo}</span>
                            </div>
                          ))}
                        </div>
                        <div>
                          <p className="font-bold border-b-2 border-black mb-2 uppercase">2. Atos Pastorais</p>
                          {report.atuacaoMinisterial.atos.map(i => (
                            <div key={i.id} className="flex justify-between border-b border-slate-50 py-1 italic">
                              <span>{i.label.substring(3)}</span> <span className="font-bold">{i.noCampo + i.foraCampo}</span>
                            </div>
                          ))}
                        </div>
                      </div>
                    </section>

                    <section className="pt-32">
                      <div className="flex justify-around text-center gap-20">
                        <div className="flex-1 border-t border-black pt-2">
                          <p className="font-bold uppercase text-[9px]">{report.outrasAtividades.local || '________________'}, {new Date().toLocaleDateString('pt-BR')}</p>
                          <p className="text-[8px] uppercase">Local e Data</p>
                        </div>
                        <div className="flex-1 border-t border-black pt-2">
                          <p className="font-bold uppercase text-[9px]">{report.identificacao.nome || '________________________________'}</p>
                          <p className="text-[8px] uppercase">Ministro Relator</p>
                        </div>
                      </div>
                    </section>
                  </div>
               </div>
            </div>
          </div>
        )}
      </main>

      {/* RODAP√â MOBILE */}
      <footer className="fixed bottom-0 inset-x-0 bg-white border-t p-4 flex justify-between items-center md:hidden no-print z-50">
        <button disabled={tab === 0} onClick={() => setTab(t => t - 1)} className="p-4 bg-slate-50 text-indigo-600 rounded-2xl"><ChevronLeft size={24} /></button>
        <span className="text-[10px] font-black text-slate-300 uppercase tracking-widest">{tab + 1} / {tabs.length}</span>
        <button disabled={tab === tabs.length - 1} onClick={() => setTab(t => t + 1)} className="p-4 bg-slate-50 text-indigo-600 rounded-2xl"><ChevronRight size={24} /></button>
      </footer>
    </div>
  );
}

// --- SUB-COMPONENTES ---

function AgendaBlock({ title, items, onAdd }) {
  return (
    <div className="bg-white p-6 rounded-[28px] shadow-sm border border-slate-100">
      <h3 className="font-black text-slate-400 text-[10px] uppercase tracking-widest mb-4 border-b pb-2">{title}</h3>
      <div className="grid grid-cols-1 gap-2">
        {items.map(item => (
          <button key={item.id} onClick={() => onAdd(item.id)}
            className="flex items-center justify-between p-4 rounded-2xl bg-slate-50 hover:bg-indigo-600 hover:text-white transition-all group active:scale-95 shadow-sm"
          >
            <span className="text-xs font-bold">{item.label}</span>
            <div className="bg-indigo-100 text-indigo-600 p-1 rounded-lg group-hover:bg-white/20 group-hover:text-white"><Plus size={16} /></div>
          </button>
        ))}
      </div>
    </div>
  );
}

function Section({ icon, title, children }) {
  return (
    <div className="bg-white rounded-[32px] p-8 shadow-sm border border-slate-100">
      <div className="flex items-center gap-3 text-indigo-600 no-print mb-6 border-b pb-2">
        {icon} <h2 className="text-[10px] font-black uppercase tracking-[2px]">{title}</h2>
      </div>
      <div>{children}</div>
    </div>
  );
}

function InputField({ label, value, onChange, type = "text", icon }) {
  return (
    <div className="flex flex-col group w-full">
      <label className="text-[8px] font-black text-slate-400 uppercase mb-1 ml-1 group-focus-within:text-indigo-600 transition-colors">{label}</label>
      <div className="relative">
        {icon && <div className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300">{icon}</div>}
        <input type={type} value={value || ''} onChange={e => onChange(e.target.value)}
          className={`w-full bg-slate-50 border-2 border-slate-50 rounded-2xl ${icon ? 'pl-11' : 'px-4'} py-3 text-sm font-bold focus:bg-white focus:border-indigo-600 outline-none transition-all`}
        />
      </div>
    </div>
  );
}

function TextAreaField({ label, value, onChange, placeholder = "" }) {
  return (
    <div className="flex flex-col w-full group">
      <label className="text-[8px] font-black text-slate-400 uppercase mb-1 ml-1 group-focus-within:text-indigo-600 transition-colors">{label}</label>
      <textarea placeholder={placeholder} value={value || ''} onChange={e => onChange(e.target.value)}
        className="bg-slate-50 border-2 border-slate-50 rounded-2xl px-5 py-4 text-sm font-bold focus:bg-white focus:border-indigo-600 outline-none transition-all min-h-[100px]"
      />
    </div>
  );
}

function StatTable({ title, icon, items, onDelta }) {
  return (
    <div className="bg-white rounded-[24px] p-6 shadow-sm border border-slate-100">
      <div className="flex items-center gap-3 text-indigo-600 mb-6 border-b pb-3">
        {icon} <h3 className="font-black text-slate-600 text-[10px] uppercase tracking-[3px]">{title}</h3>
      </div>
      <div className="space-y-4">
        <div className="grid grid-cols-12 gap-2 text-[8px] font-black text-slate-300 uppercase px-1 no-print">
          <div className="col-span-6">Descri√ß√£o</div>
          <div className="col-span-3 text-center">No Campo</div>
          <div className="col-span-3 text-center">Fora</div>
        </div>
        {items.map(item => (
          <div key={item.id} className="grid grid-cols-12 gap-2 items-center py-2 border-b last:border-0 border-slate-50">
            <div className="col-span-6 text-[10px] font-bold text-slate-700 leading-tight pr-2">{item.label}</div>
            <div className="col-span-3">
              <Counter value={item.noCampo} onInc={() => onDelta(item.id, 'noCampo', 1)} onDec={() => onDelta(item.id, 'noCampo', -1)} />
            </div>
            <div className="col-span-3">
              <Counter value={item.foraCampo} onInc={() => onDelta(item.id, 'foraCampo', 1)} onDec={() => onDelta(item.id, 'foraCampo', -1)} />
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

function Counter({ value, onInc, onDec }) {
  return (
    <div className="flex items-center justify-between bg-slate-50 p-1 rounded-xl border border-slate-100 w-full h-[38px] no-print">
      <button onClick={(e) => {e.preventDefault(); onDec();}} className="w-8 h-8 flex items-center justify-center hover:bg-white rounded-lg text-slate-300 hover:text-red-500 transition-all active:scale-75"><Minus size={12} /></button>
      <div className="flex-1 flex items-center justify-center">
         <span className="text-[12px] font-black text-indigo-950 leading-none h-auto w-auto flex items-center justify-center">{value || 0}</span>
      </div>
      <button onClick={(e) => {e.preventDefault(); onInc();}} className="w-8 h-8 flex items-center justify-center hover:bg-white rounded-lg text-slate-300 hover:text-indigo-600 transition-all active:scale-75"><Plus size={12} /></button>
    </div>
  );
}

function SelectField({ label, value, options, onChange }) {
  return (
    <div className="flex flex-col w-full group">
      <label className="text-[8px] font-black text-slate-400 uppercase mb-1 ml-1 group-focus-within:text-indigo-600 transition-colors">{label}</label>
      <select value={value || ''} onChange={e => onChange(e.target.value)}
        className="bg-slate-50 border-2 border-slate-50 rounded-xl px-4 py-3 text-sm font-bold focus:bg-white focus:border-indigo-600 outline-none transition-all"
      >
        {Array.isArray(options) ? options.map(o => <option key={o} value={o}>{o}</option>) : Object.entries(options).map(([k, v]) => <option key={k} value={k}>{v}</option>)}
      </select>
    </div>
  );
}

function Checkbox({ label, checked, onChange }) {
  return (
    <label className="flex items-center gap-3 cursor-pointer group p-1">
      <div className={`w-6 h-6 rounded-lg border-2 flex items-center justify-center transition-all ${checked ? 'bg-indigo-600 border-indigo-600 shadow-md' : 'bg-white border-slate-200 group-hover:border-indigo-300'}`}>
        {checked && <div className="w-1.5 h-1.5 bg-white rounded-full"></div>}
      </div>
      <input type="checkbox" className="hidden" checked={checked} onChange={e => onChange(e.target.checked)} />
      <span className="text-[10px] font-black text-slate-500 uppercase tracking-tighter group-hover:text-indigo-600 transition-colors">{label}</span>
    </label>
  );
}

